// Database configuration
let db;
const DB_NAME = 'MusicPlayerDB';
const DB_VERSION = 1;
const STORE_NAME = 'songs';

// DOM Elements
const image = document.getElementById('cover');
const title = document.getElementById('music-title');
const artist = document.getElementById('music-artist');
const currentTimeEl = document.getElementById('current-time');
const durationEl = document.getElementById('duration');
const progress = document.getElementById('progress');
const playerProgress = document.getElementById('player-progress');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const playBtn = document.getElementById('play');
const background = document.getElementById('bg-img');

// Audio initialization
const music = new Audio();

// Default songs
const defaultSongs = [
    {
        path: 'songs/1.mp3',
        displayName: 'The Charmer\'s Call',
        cover: 'songs/2.jpg',
        artist: 'Hanu Dixit',
    },
    {
        path: 'songs/2.mp3',
        displayName: 'You Will Never See Me Coming',
        cover: 'songs/2.jpg',
        artist: 'NEFFEX',
    },
];

// Initialize songs array with default songs
let songs = [...defaultSongs];
let musicIndex = 0;
let isPlaying = false;

// Database Functions
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('displayName', 'displayName', { unique: false });
                store.createIndex('artist', 'artist', { unique: false });
            }
        };
    });
}

async function loadSongsFromDB() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(STORE_NAME, 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = () => {
            const dbSongs = request.result;
            songs = [...defaultSongs, ...dbSongs];
            resolve(songs);
        };

        request.onerror = () => reject(request.error);
    });
}

async function storeSong(song) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(STORE_NAME, 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(song);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function deleteSong(songId) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(STORE_NAME, 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(songId);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

// Player Functions
function togglePlay() {
    if (isPlaying) {
        pauseMusic();
    } else {
        playMusic();
    }
}

function playMusic() {
    isPlaying = true;
    playBtn.classList.replace('fa-play', 'fa-pause');
    playBtn.setAttribute('title', 'Pause');
    music.play();
}

function pauseMusic() {
    isPlaying = false;
    playBtn.classList.replace('fa-pause', 'fa-play');
    playBtn.setAttribute('title', 'Play');
    music.pause();
}

function loadMusic(song) {
    music.src = song.path;
    title.textContent = song.displayName;
    artist.textContent = song.artist;
    image.src = song.cover;
    background.src = song.cover;
}

function changeMusic(direction) {
    musicIndex = (musicIndex + direction + songs.length) % songs.length;
    loadMusic(songs[musicIndex]);
    playMusic();
}

function updateProgressBar() {
    const { duration, currentTime } = music;
    const progressPercent = (currentTime / duration) * 100;
    progress.style.width = `${progressPercent}%`;

    const formatTime = (time) => String(Math.floor(time)).padStart(2, '0');
    durationEl.textContent = `${formatTime(duration / 60)}:${formatTime(duration % 60)}`;
    currentTimeEl.textContent = `${formatTime(currentTime / 60)}:${formatTime(currentTime % 60)}`;
}

function setProgressBar(e) {
    const width = playerProgress.clientWidth;
    const clickX = e.offsetX;
    music.currentTime = (clickX / width) * music.duration;
}

// Playlist Functions
const playlistBtn = document.getElementById('playlist');
const playlistModal = document.createElement('div');
playlistModal.id = 'playlist-modal';
playlistModal.innerHTML = `
    <div class="playlist-content">
        <span id="close-playlist" class="close-playlist"><i class="fas fa-times"></i></span>
        <h2><i class="fas fa-music"></i> Playlist</h2>
        <ul id="playlist-container"></ul>
        <button id="upload"><i class="fas fa-upload"></i></button>
    </div>
`;
document.body.appendChild(playlistModal);

const playlistContainer = document.getElementById('playlist-container');
const closePlaylistBtn = document.getElementById('close-playlist');
const uploadBtn = document.getElementById('upload');

function displayPlaylist() {
    playlistContainer.innerHTML = '';

    songs.forEach((song, index) => {
        const songItem = document.createElement('li');
        const songTitle = document.createElement('span');
        songTitle.textContent = `${song.displayName} - ${song.artist}`;
        songItem.appendChild(songTitle);

        songTitle.addEventListener('click', () => {
            musicIndex = index;
            loadMusic(songs[index]);
            playMusic();
            togglePlaylist();
        });

        if (song.id) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.className = 'delete-song';
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this song?')) {
                    try {
                        await deleteSong(song.id);
                        await loadSongsFromDB();
                        displayPlaylist();
                        
                        if (musicIndex === index) {
                            musicIndex = 0;
                            loadMusic(songs[0]);
                            if (isPlaying) playMusic();
                        }
                    } catch (error) {
                        console.error('Error deleting song:', error);
                        alert('Error deleting song. Please try again.');
                    }
                }
            });
            songItem.appendChild(deleteBtn);
        }

        playlistContainer.appendChild(songItem);
    });
}

function togglePlaylist() {
    playlistModal.classList.toggle('open');
    if (playlistModal.classList.contains('open')) {
        displayPlaylist();
    }
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('audio/')) {
        try {
            const reader = new FileReader();
            reader.onload = async function() {
                const newSong = {
                    path: reader.result,
                    displayName: file.name.replace(/\.[^/.]+$/, ''),
                    cover: 'songs/2.jpg',
                    artist: 'Unknown Artist',
                    uploadDate: new Date().toISOString()
                };

                await storeSong(newSong);
                await loadSongsFromDB();
                alert('Song uploaded successfully!');
                displayPlaylist();
            };
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error uploading song:', error);
            alert('Error uploading song. Please try again.');
        }
    } else {
        alert('Please upload a valid audio file.');
    }
}

// Event Listeners
playBtn.addEventListener('click', togglePlay);
prevBtn.addEventListener('click', () => changeMusic(-1));
nextBtn.addEventListener('click', () => changeMusic(1));
music.addEventListener('ended', () => changeMusic(1));
music.addEventListener('timeupdate', updateProgressBar);
playerProgress.addEventListener('click', setProgressBar);
closePlaylistBtn.addEventListener('click', togglePlaylist);
playlistBtn.addEventListener('click', togglePlaylist);
uploadBtn.addEventListener('click', function () {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'audio/*';
    fileInput.addEventListener('change', handleFileUpload);
    fileInput.click();
});

// Initialize application
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await initDB();
        await loadSongsFromDB();
        loadMusic(songs[musicIndex]);
    } catch (error) {
        console.error('Error initializing database:', error);
        alert('Error loading songs. Please refresh the page.');
    }
});
